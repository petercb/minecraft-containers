version: 2.1

orbs:
  docker: circleci/docker@2.0.1

parameters:
  minecraft-java-version:
    type: string
    default: "1.17.1"
  minecraft-java-build:
    type: string
    default: "391"
  minecraft-java-repo:
    type: string
    default: minecraft-java

jobs:
  bedrock-connect:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.09.3
      - docker/check
      - run:
          name: BuildX
          environment:
            DOCKER_REPO: bedrock-connect
            VERSION: 1.12
          working_directory: bedrockconnect
          command: >-
            docker buildx build
            --push
            --platform linux/arm64/v8,linux/amd64
            --build-arg VERSION=${VERSION}
            --cache-from ${DOCKER_LOGIN}/${DOCKER_REPO}:cache
            --cache-to ${DOCKER_LOGIN}/${DOCKER_REPO}:cache
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:${VERSION}-<< pipeline.number >>
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:${VERSION}
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:latest
            .

workflows:
  version: 2
  container-build:
    jobs:
      - bedrock-connect:
          context: DockerHub
      - docker/publish:
          name: minecraft-java
          context: DockerHub
          cache_from: "${DOCKER_LOGIN}/<< pipeline.parameters.minecraft-java-repo >>:latest"
          image: "${DOCKER_LOGIN}/<< pipeline.parameters.minecraft-java-repo >>"
          tag: "<< pipeline.parameters.minecraft-java-version >>-<< pipeline.number >>,<< pipeline.parameters.minecraft-java-version >>,latest"
          extra_build_args: >-
            --build-arg VERSION=<< pipeline.parameters.minecraft-java-version >>
            --build-arg BUILD_ID=<< pipeline.parameters.minecraft-java-build >>
          docker-context: minecraft-java
          dockerfile: minecraft-java/Dockerfile
