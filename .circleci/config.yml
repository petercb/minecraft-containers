version: 2.1

orbs:
  docker: circleci/docker@2.0.1

parameters:
  bedrock-connect-version:
    type: string
    default: "1.12"
  bedrock-connect-repo:
    type: string
    default: bedrock-connect

jobs:
  bedrock-connect:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.09.3
      - docker/check
      - run:
          name: BuildX
          environment:
            DOCKER_REPO: bedrock-connect
            VERSION: 1.12
          working_directory: bedrockconnect
          command: >-
            docker buildx build
            --push
            --platform linux/arm64/v8,linux/amd64
            --build-arg VERSION=${VERSION}
            --cache-from ${DOCKER_LOGIN}/${DOCKER_REPO}:cache
            --cache-to ${DOCKER_LOGIN}/${DOCKER_REPO}:cache
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:${VERSION}-<< pipeline.number >>
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:${VERSION}
            --tag ${DOCKER_LOGIN}/${DOCKER_REPO}:latest
            .

workflows:
  version: 2
  container-build:
    jobs:
      - bedrock-connect:
          context: DockerHub
