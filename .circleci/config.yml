version: 2.1

orbs:
  docker: circleci/docker@2.0.1

jobs:
  buildx:
    parameters:
      extra-args:
        type: string
        default: ""
      platforms:
        type: string
        default: linux/arm64/v8,linux/amd64
      repo-name:
        type: string
      version:
        type: string
      work-dir:
        type: string
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.09.3
      - docker/check
      - run:
          name: build
          working_directory: << parameters.work-dir >>
          command: >-
            docker buildx build
            --push
            --platform << parameters.platforms >>
            --build-arg VERSION=<< parameters.version >>
            --build-arg BUILDKIT_INLINE_CACHE=1
            <<# parameters.extra-args >>
            << parameters.extra-args >>
            <</ parameters.extra-args >>
            --cache-from ${DOCKER_LOGIN}/<< parameters.repo-name >>:cache
            --cache-to ${DOCKER_LOGIN}/<< parameters.repo-name >>:cache
            --tag ${DOCKER_LOGIN}/<< parameters.repo-name >>:<< parameters.version >>-<< pipeline.number >>
            --tag ${DOCKER_LOGIN}/<< parameters.repo-name >>:<< parameters.version >>
            --tag ${DOCKER_LOGIN}/<< parameters.repo-name >>:latest
            .

workflows:
  version: 2
  container-build:
    jobs:
      - buildx:
          name: bedrock-connect
          context: DockerHub
          repo-name: bedrock-connect
          version: "1.12"
          work-dir: bedrockconnect
      - buildx:
          name: minecraft-java
          context: DockerHub
          platforms: linux/amd64
          repo-name: minecraft-java
          version: "1.17.1"
          work-dir: minecraft-java
          extra-args: >-
            --build-arg BUILD_ID=391
      - buildx:
          name: velocity-proxy
          context: DockerHub
          repo-name: velocity-proxy
          version: "3.1.0"
          work-dir: velocity-proxy
          extra-args: >-
            --build-arg BUILD_ID=95
