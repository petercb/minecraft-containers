version: 2.1

parameters:
  docker-org:
    type: string
    default: petercb

workflows:
  version: 2
  default:
    jobs:
      - container:
          context: DockerHub

jobs:
  container:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.09.3
      - run:
          name: Docker Login
          command: echo "${DOCKER_PASSWORD}" | docker login -u "<< pipeline.parameters.docker-org >>" --password-stdin

      - run:
          name: Bedrock-Connect
          environment:
            DOCKER_REPO: bedrock-connect
            VERSION: 1.6.3
          working_directory: bedrockconnect
          command: |
            echo "Building << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION}"
            docker buildx build --push \
              --platform linux/arm/v7,linux/arm64/v8,linux/amd64 \
              --build-arg VERSION=${VERSION} \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION} \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:latest \
              .
      - run:
          name: Velocity
          environment:
            DOCKER_REPO: velocity-proxy
            VERSION: 1.1.4
          working_directory: velocity-proxy
          command: |
            echo "Building << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION}"
            docker buildx build --push \
              --platform linux/arm/v7,linux/arm64/v8,linux/amd64 \
              --build-arg VERSION=${VERSION} \
              --target base \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION} \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:latest \
              .
      - run:
          name: Velocity with Geyser
          environment:
            DOCKER_REPO: velocity-proxy
            VERSION: 1.1.4
          working_directory: velocity-proxy
          command: |
            echo "Building << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION}-geyser"
            docker buildx build --push \
              --platform linux/arm/v7,linux/arm64/v8,linux/amd64 \
              --build-arg VERSION=${VERSION} \
              --target geyser \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION}-geyser \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:latest-geyser \
              .
      - run:
          name: Minecraft (Java)
          environment:
            DOCKER_REPO: minecraft-java
            VERSION: 1.16.5
            URL: https://launcher.mojang.com/v1/objects/1b557e7b033b583cd9f66746b7a9ab1ec1673ced/server.jar
          working_directory: minecraft-java
          command: |
            echo "Building << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION}"
            docker buildx build --push \
              --platform linux/arm/v7,linux/arm64/v8,linux/amd64 \
              --build-arg VERSION=${VERSION} \
              --build-arg SOURCE_URL=${URL} \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:${VERSION} \
              --tag << pipeline.parameters.docker-org >>/${DOCKER_REPO}:latest \
              .
