version: 2.1

orbs:
  docker: circleci/docker@2.0.1

parameters:
  bedrock-connect-version:
    type: string
    default: "1.12"
  bedrock-connect-repo:
    type: string
    default: bedrock-connect

executors:
  arm:
    machine:
      image: ubuntu-2004:202101-01
    resource_class: arm.medium

workflows:
  version: 2
  container-build:
    jobs:
      - docker/publish:
          name: << pipeline.parameters.bedrock-connect-repo >> ARMv8
          context: DockerHub
          executor: arm
          cache_from: "${DOCKER_LOGIN}/<< pipeline.parameters.bedrock-connect-repo >>:latest"
          image: "${DOCKER_LOGIN}/<< pipeline.parameters.bedrock-connect-repo >>"
          tag: "<< pipeline.parameters.bedrock-connect-version >>-<< pipeline.number >>,<< pipeline.parameters.bedrock-connect-version >>,latest"
          extra_build_args: "--build-arg VERSION=<< pipeline.parameters.bedrock-connect-version >>"
          docker-context: bedrockconnect
          dockerfile: bedrockconnect/Dockerfile
      - docker/publish:
          name: << pipeline.parameters.bedrock-connect-repo >> AMD64
          context: DockerHub
          cache_from: "${DOCKER_LOGIN}/<< pipeline.parameters.bedrock-connect-repo >>:latest"
          image: "${DOCKER_LOGIN}/<< pipeline.parameters.bedrock-connect-repo >>"
          tag: "<< pipeline.parameters.bedrock-connect-version >>-<< pipeline.number >>,<< pipeline.parameters.bedrock-connect-version >>,latest"
          extra_build_args: "--build-arg VERSION=<< pipeline.parameters.bedrock-connect-version >>"
          docker-context: bedrockconnect
          dockerfile: bedrockconnect/Dockerfile
